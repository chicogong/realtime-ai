<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure ASR & LLM å­—å¹•æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
            height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .status-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status {
            font-size: 14px;
            color: #666;
        }
        
        .status.listening {
            color: #2ecc71;
        }
        
        .status.thinking {
            color: #3498db;
        }
        
        .status.error {
            color: #e74c3c;
        }
        
        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        button.stop {
            background-color: #e74c3c;
        }
        
        button.stop:hover {
            background-color: #c0392b;
        }
        
        .subtitle-container {
            width: 100%;
            min-height: 120px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .partial-transcript {
            font-size: 24px;
            margin-bottom: 10px;
            min-height: 36px;
            color: #f1c40f;
        }
        
        .final-transcript {
            font-size: 16px;
            color: #bdc3c7;
            margin-top: 10px;
            font-style: italic;
        }
        
        .llm-response-container {
            width: 100%;
            min-height: 120px;
            border-radius: 8px;
            background-color: rgba(52, 73, 94, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            transition: opacity 0.3s;
        }
        
        .llm-response {
            font-size: 20px;
            color: #ecf0f1;
            line-height: 1.5;
        }
        
        .llm-status {
            font-size: 14px;
            color: #bdc3c7;
            margin-top: 10px;
            font-style: italic;
        }
        
        .history-container {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .history-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .history-item-user {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        
        .history-item-llm {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #8e44ad;
            padding-left: 15px;
        }
        
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-dot.listening {
            background-color: #2ecc71;
            box-shadow: 0 0 5px #2ecc71;
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.thinking {
            background-color: #3498db;
            box-shadow: 0 0 5px #3498db;
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.idle {
            background-color: #95a5a6;
        }
        
        .status-dot.error {
            background-color: #e74c3c;
        }

        .browser-warning {
            background-color: #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            display: none;
        }
        
        .typing-indicator {
            display: inline-block;
        }
        
        .typing-indicator span {
            height: 5px;
            width: 5px;
            margin-right: 3px;
            border-radius: 50%;
            background-color: #bdc3c7;
            display: inline-block;
            animation: typingPulse 1s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        @keyframes typingPulse {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Azure ASR & LLM å­—å¹•æ¼”ç¤º</h1>
        
        <div id="browser-warning" class="browser-warning">
            <strong>æ³¨æ„:</strong> æœ¬åº”ç”¨éœ€è¦ä½¿ç”¨æ”¯æŒéŸ³é¢‘APIçš„ç°ä»£æµè§ˆå™¨ï¼Œå¹¶ä¸”éœ€è¦å…è®¸éº¦å…‹é£è®¿é—®æƒé™ã€‚è¯·ä½¿ç”¨Chromeã€Edgeæˆ–Firefoxçš„æœ€æ–°ç‰ˆæœ¬ã€‚
        </div>
        
        <div class="status-container">
            <div class="status">
                <span class="status-dot idle" id="status-dot"></span>
                <span id="status-text">å‡†å¤‡å°±ç»ª</span>
            </div>
        </div>
        
        <div class="controls">
            <button id="start-btn">å¼€å§‹å½•éŸ³</button>
            <button id="stop-btn" class="stop" disabled>åœæ­¢å½•éŸ³</button>
            <button id="reset-btn">é‡ç½®</button>
        </div>
        
        <div class="subtitle-container">
            <div class="partial-transcript" id="partial-transcript"></div>
            <div class="final-transcript" id="final-transcript"></div>
        </div>
        
        <div class="llm-response-container">
            <div class="llm-response" id="llm-response"></div>
            <div class="llm-status" id="llm-status"></div>
        </div>
        
        <div class="history-container" id="history-container">
            <h3>å¯¹è¯å†å²</h3>
            <div id="history"></div>
        </div>
    </div>
    
    <script>
        // Audio configuration
        const SAMPLE_RATE = 16000;  // Azureéœ€è¦16kHzé‡‡æ ·ç‡
        const SAMPLE_SIZE = 16;
        const CHANNELS = 1;
        const BUFFER_SIZE = 4096;
        
        // WebSocket and recording variables
        let socket = null;
        let mediaStream = null;
        let audioContext = null;
        let processor = null;
        let isRecording = false;
        
        // å¦‚æœæµè§ˆå™¨çš„éŸ³é¢‘é‡‡æ ·ç‡ä¸ç›®æ ‡ä¸åŒï¼Œéœ€è¦é‡é‡‡æ ·
        let resampleRequired = false;
        let originalSampleRate = 0;
        
        // AIå“åº”çŠ¶æ€
        let isAIResponding = false; // æ–°å¢ï¼šè¿½è¸ªAIæ˜¯å¦æ­£åœ¨å“åº”
        
        // DOM elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const partialTranscript = document.getElementById('partial-transcript');
        const finalTranscript = document.getElementById('final-transcript');
        const llmResponse = document.getElementById('llm-response');
        const llmStatus = document.getElementById('llm-status');
        const history = document.getElementById('history');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const browserWarning = document.getElementById('browser-warning');
        
        // éŸ³é¢‘æ’­æ”¾ç›¸å…³å˜é‡
        let audioQueue = [];               // éŸ³é¢‘ç¼“å†²åŒºé˜Ÿåˆ—
        let isPlayingAudio = false;        // æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘
        let pendingAudioBuffer = null;     // å¾…å¤„ç†çš„éŸ³é¢‘ç¼“å†²åŒº
        let currentAudioSource = null;     // å½“å‰éŸ³é¢‘æº
        let audioBufferQueue = [];         // å­˜å‚¨æ­£åœ¨æ„å»ºçš„å¥å­éŸ³é¢‘å—
        let currentSentenceId = null;      // å½“å‰æ­£åœ¨æ„å»ºçš„å¥å­ID
        let activeSentences = new Map();   // å½“å‰æ´»åŠ¨çš„å¥å­ï¼Œé”®ä¸ºå¥å­IDï¼Œå€¼ä¸ºå¥å­æ•°æ®
        let sentencePlayQueue = [];        // å¥å­æ’­æ”¾é˜Ÿåˆ—
        let isProcessingSentence = false;  // æ˜¯å¦æ­£åœ¨å¤„ç†å¥å­
        
        // Check browser compatibility
        function checkBrowserCompatibility() {
            // Check if mediaDevices API is available
            if (!navigator.mediaDevices) {
                browserWarning.style.display = 'block';
                browserWarning.innerHTML = '<strong>é”™è¯¯:</strong> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶åŠŸèƒ½ã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Edgeæˆ–Firefoxæµè§ˆå™¨ã€‚';
                startBtn.disabled = true;
                return false;
            }
            
            // Check if getUserMedia is available
            if (!navigator.mediaDevices.getUserMedia) {
                browserWarning.style.display = 'block';
                browserWarning.innerHTML = '<strong>é”™è¯¯:</strong> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®åŠŸèƒ½ã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Edgeæˆ–Firefoxæµè§ˆå™¨ã€‚';
                startBtn.disabled = true;
                return false;
            }
            
            // Check if AudioContext is available
            if (!window.AudioContext && !window.webkitAudioContext) {
                browserWarning.style.display = 'block';
                browserWarning.innerHTML = '<strong>é”™è¯¯:</strong> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å¤„ç†åŠŸèƒ½ã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Edgeæˆ–Firefoxæµè§ˆå™¨ã€‚';
                startBtn.disabled = true;
                return false;
            }
            
            // Check if we're in a secure context (HTTPS or localhost)
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                browserWarning.style.display = 'block';
                browserWarning.innerHTML = '<strong>è­¦å‘Š:</strong> éº¦å…‹é£è®¿é—®å¯èƒ½éœ€è¦HTTPSè¿æ¥ã€‚å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·å°è¯•ä½¿ç”¨HTTPSæˆ–åœ¨æœ¬åœ°è¿è¡Œåº”ç”¨ã€‚';
            }
            
            return true;
        }
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                socket.close();
            }
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                showDebugMessage('WebSocketè¿æ¥æˆåŠŸ');
                updateStatus('idle', 'å·²è¿æ¥ï¼Œå‡†å¤‡å°±ç»ª');
                startBtn.disabled = !checkBrowserCompatibility();
            };
            
            socket.onmessage = function(event) {
                try {
                    // åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼‰
                    if (typeof event.data === 'string') {
                        // JSONæ¶ˆæ¯
                        const data = JSON.parse(event.data);
                        
                        // å¦‚æœæ˜¯äºŒè¿›åˆ¶å¤´éƒ¨æ¶ˆæ¯ï¼Œå‡†å¤‡æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®
                        if (data.type === 'tts_binary_header') {
                            console.log(`æ”¶åˆ°äºŒè¿›åˆ¶å¤´ä¿¡æ¯: å— #${data.chunk_number}, å¥å­ID: ${data.sentence_id}`);
                            showDebugMessage(`æ”¶åˆ°äºŒè¿›åˆ¶å¤´ä¿¡æ¯: å— #${data.chunk_number}`);
                            
                            // è®¾ç½®å½“å‰æ¥æ”¶çš„äºŒè¿›åˆ¶å¤´ä¿¡æ¯ï¼Œåç»­çš„äºŒè¿›åˆ¶æ•°æ®ä¼šä½¿ç”¨è¿™ä¸ª
                            window.currentBinaryHeader = data;
                            return;
                        }
                        
                        // å¤„ç†æ™®é€šJSONæ¶ˆæ¯
                        handleSocketMessage(data);
                    } else if (event.data instanceof Blob) {
                        // äºŒè¿›åˆ¶æ•°æ®ï¼Œé€šå¸¸æ˜¯åœ¨tts_binary_headerä¹‹å
                        showDebugMessage(`æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®: ${event.data.size}å­—èŠ‚`);
                        
                        if (window.currentBinaryHeader) {
                            handleBinaryAudioData(event.data, window.currentBinaryHeader);
                            window.currentBinaryHeader = null; // æ¸…é™¤å¤´ä¿¡æ¯
                        } else {
                            console.error('æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®ä½†æ²¡æœ‰å¯¹åº”çš„å¤´ä¿¡æ¯');
                            showDebugMessage('é”™è¯¯: æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®ä½†æ²¡æœ‰å¤´ä¿¡æ¯');
                        }
                    }
                } catch (e) {
                    console.error('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:', e);
                    showDebugMessage(`å¤„ç†æ¶ˆæ¯é”™è¯¯: ${e.message}`);
                }
            };
            
            socket.onclose = function(event) {
                console.log('WebSocketè¿æ¥å…³é—­');
                showDebugMessage('WebSocketè¿æ¥å…³é—­');
                updateStatus('error', 'è¿æ¥å·²æ–­å¼€');
                startBtn.disabled = true;
                stopBtn.disabled = true;
                isRecording = false;
                
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(function() {
                    console.log('å°è¯•é‡æ–°è¿æ¥...');
                    showDebugMessage('å°è¯•é‡æ–°è¿æ¥...');
                    initializeWebSocket();
                }, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                showDebugMessage('WebSocketé”™è¯¯');
                updateStatus('error', 'è¿æ¥é”™è¯¯');
            };
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugMessage(message) {
            // åˆ›å»ºè°ƒè¯•åŒºåŸŸï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let debugArea = document.getElementById('debug-area');
            if (!debugArea) {
                debugArea = document.createElement('div');
                debugArea.id = 'debug-area';
                debugArea.style.position = 'fixed';
                debugArea.style.bottom = '10px';
                debugArea.style.right = '10px';
                debugArea.style.width = '300px';
                debugArea.style.maxHeight = '200px';
                debugArea.style.overflow = 'auto';
                debugArea.style.backgroundColor = 'rgba(0,0,0,0.7)';
                debugArea.style.color = 'white';
                debugArea.style.padding = '10px';
                debugArea.style.borderRadius = '5px';
                debugArea.style.fontSize = '12px';
                debugArea.style.fontFamily = 'monospace';
                debugArea.style.zIndex = '1000';
                document.body.appendChild(debugArea);
            }
            
            // æ·»åŠ æ¶ˆæ¯
            const msgElement = document.createElement('div');
            msgElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugArea.appendChild(msgElement);
            
            // ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
            debugArea.scrollTop = debugArea.scrollHeight;
            
            // é™åˆ¶æ¶ˆæ¯æ•°é‡
            while (debugArea.childNodes.length > 20) {
                debugArea.removeChild(debugArea.firstChild);
            }
        }
        
        // éŸ³é¢‘å·¥å…·æ 
        function addAudioToolbar() {
            let toolbar = document.getElementById('audio-toolbar');
            if (!toolbar) {
                toolbar = document.createElement('div');
                toolbar.id = 'audio-toolbar';
                toolbar.style.position = 'fixed';
                toolbar.style.top = '10px';
                toolbar.style.right = '10px';
                toolbar.style.backgroundColor = 'rgba(0,0,0,0.7)';
                toolbar.style.color = 'white';
                toolbar.style.padding = '10px';
                toolbar.style.borderRadius = '5px';
                toolbar.style.zIndex = '1000';
                
                // åˆ›å»ºæŒ‰é’®
                const testAudioBtn = document.createElement('button');
                testAudioBtn.textContent = 'æµ‹è¯•éŸ³é¢‘';
                testAudioBtn.style.marginRight = '5px';
                testAudioBtn.onclick = testAudioPlayback;
                
                const resetAudioBtn = document.createElement('button');
                resetAudioBtn.textContent = 'é‡ç½®éŸ³é¢‘';
                resetAudioBtn.onclick = resetAudioContext;
                
                // æ·»åŠ æŒ‰é’®åˆ°å·¥å…·æ 
                toolbar.appendChild(testAudioBtn);
                toolbar.appendChild(resetAudioBtn);
                
                document.body.appendChild(toolbar);
            }
        }
        
        // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
        function testAudioPlayback() {
            if (!audioContext) {
                initAudioContext();
            }
            
            showDebugMessage('æµ‹è¯•éŸ³é¢‘æ’­æ”¾');
            
            // åˆ›å»ºæµ‹è¯•éŸ³é¢‘ï¼ˆ1ç§’çš„440Hzæ­£å¼¦æ³¢ï¼‰
            const duration = 1;
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < buffer.length; i++) {
                data[i] = Math.sin(440 * Math.PI * 2 * i / sampleRate);
            }
            
            // æ’­æ”¾æµ‹è¯•éŸ³é¢‘
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start();
            
            showDebugMessage('æµ‹è¯•éŸ³é¢‘å¼€å§‹æ’­æ”¾');
        }
        
        // é‡ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
        function resetAudioContext() {
            showDebugMessage('æ­£åœ¨é‡ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡...');
            
            if (audioContext) {
                audioContext.close().then(() => {
                    audioContext = null;
                    showDebugMessage('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å…³é—­');
                    initAudioContext();
                    showDebugMessage('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²é‡æ–°åˆå§‹åŒ–');
                }).catch(err => {
                    showDebugMessage(`å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡é”™è¯¯: ${err.message}`);
                });
            } else {
                initAudioContext();
                showDebugMessage('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–');
            }
        }
        
        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        function initAudioContext() {
            try {
                if (audioContext) {
                    // å¦‚æœå·²ç»å­˜åœ¨å¹¶ä¸”çŠ¶æ€æ˜¯runningæˆ–suspendedï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                    if (audioContext.state === "running" || audioContext.state === "suspended") {
                        if (audioContext.state === "suspended") {
                            audioContext.resume();
                        }
                        return true;
                    }
                    
                    // å¦‚æœçŠ¶æ€æ˜¯closedï¼Œåˆ™éœ€è¦åˆ›å»ºæ–°çš„
                    try {
                        audioContext.close();
                    } catch (e) {
                        console.warn("Error closing old audio context:", e);
                    }
                }
                
                // åˆ›å»ºæ–°çš„éŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log(`Audio context initialized with sample rate: ${audioContext.sampleRate}Hz`);
                return true;
            } catch (e) {
                console.error('Failed to initialize audio context:', e);
                return false;
            }
        }
        
        // å°†Base64ç¼–ç çš„PCMæ•°æ®è§£ç ä¸ºArrayBuffer
        function decodeBase64ToPCM(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        // å°†PCMæ•°æ®è½¬æ¢ä¸ºAudioBuffer
        async function pcmToAudioBuffer(pcmData) {
            if (!audioContext) {
                if (!initAudioContext()) {
                    throw new Error("Failed to initialize audio context");
                }
            }
            
            console.log(`è½¬æ¢PCMæ•°æ®åˆ°AudioBuffer, å¤§å°: ${pcmData.byteLength} å­—èŠ‚`);
            
            try {
                // åˆ›å»º16ä½PCM AudioBuffer
                const audioBuffer = audioContext.createBuffer(1, pcmData.byteLength / 2, 16000);
                
                // è·å–éŸ³é¢‘é€šé“æ•°æ®
                const channelData = audioBuffer.getChannelData(0);
                
                // å°†PCMæ•°æ®è½¬æ¢ä¸ºFloat32Array
                const pcmInt16 = new Int16Array(pcmData);
                for (let i = 0; i < pcmInt16.length; i++) {
                    // å°†16ä½PCMå€¼ï¼ˆ-32768åˆ°32767ï¼‰è½¬æ¢ä¸º-1.0åˆ°1.0èŒƒå›´çš„float
                    channelData[i] = pcmInt16[i] / 32768.0;
                }
                
                console.log(`PCMè½¬æ¢å®Œæˆ, æ ·æœ¬æ•°: ${channelData.length}`);
                return audioBuffer;
            } catch (e) {
                console.error('PCMè½¬æ¢å¤±è´¥:', e);
                throw e;
            }
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleSocketMessage(data) {
            switch (data.type) {
                case 'partial_transcript':
                    partialTranscript.textContent = data.content;
                    break;
                
                case 'final_transcript':
                    finalTranscript.textContent = data.content;
                    // Add to history
                    addToHistory(data.content, 'user');
                    // Clear partial after a short delay
                    setTimeout(() => {
                        partialTranscript.textContent = '';
                    }, 1000);
                    break;
                
                case 'llm_status':
                    if (data.status === 'processing') {
                        updateStatus('thinking', 'AIæ€è€ƒä¸­...');
                        llmStatus.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div> AIæ€è€ƒä¸­...';
                        llmResponse.textContent = '';
                        
                        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
                        initAudioContext();
                        
                        // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                        stopAudioPlayback();
                        
                        // æ¸…ç©ºæ‰€æœ‰å¥å­ç›¸å…³çŠ¶æ€
                        clearAllSentences();
                        
                        // æ–°å¢ï¼šæ ‡è®°AIå¼€å§‹å“åº”
                        isAIResponding = true;
                    }
                    break;
                
                case 'llm_response':
                    // Show streaming response
                    llmResponse.textContent = data.content;
                    
                    // If response is complete
                    if (data.is_complete) {
                        // Update status
                        updateStatus('idle', 'å·²å®Œæˆ');
                        llmStatus.textContent = 'å›ç­”å·²å®Œæˆ';
                        
                        // Add to history
                        addToHistory(data.content, 'llm');
                        
                        // Clear status after delay
                        setTimeout(() => {
                            llmStatus.textContent = '';
                        }, 2000);
                        
                        // æ–°å¢ï¼šæ ‡è®°AIå“åº”ç»“æŸ
                        isAIResponding = false;
                    }
                    break;
                
                case 'tts_sentence_start':
                    // å¥å­å¼€å§‹æ ‡è®°ï¼Œåˆå§‹åŒ–å¥å­çŠ¶æ€
                    initSentence(data.sentence_id, data.text, data.is_first);
                    break;
                
                case 'tts_sentence_end':
                    // å¥å­ç»“æŸæ ‡è®°ï¼Œæ ‡è®°å¥å­å®Œæˆ
                    finalizeSentence(data.sentence_id);
                    
                    // ç¡®ä¿å¥å­è¢«å¤„ç†
                    processSentenceQueue();
                    break;
                
                case 'tts_audio_chunk':
                    // å¤„ç†æµå¼TTSéŸ³é¢‘å—ï¼ˆå…¼å®¹æ—§ç‰ˆbase64æ ¼å¼ï¼‰
                    if (data.is_last_chunk) {
                        // è¿™æ˜¯æœ€åä¸€ä¸ªå—ï¼Œæ ‡è®°æµå¼æ’­æ”¾ç»“æŸ
                        console.log(`TTSæµå¼ç»“æŸ: ${data.text || "æœªçŸ¥æ–‡æœ¬"}`);
                        
                        // å¦‚æœæœ‰å¥å­IDï¼Œæ ‡è®°å¥å­å®Œæˆ
                        if (data.sentence_id) {
                            finalizeSentence(data.sentence_id);
                        } else if (currentSentenceId) {
                            finalizeSentence(currentSentenceId);
                        }
                        
                        // ç¡®ä¿å¥å­è¢«å¤„ç†
                        processSentenceQueue();
                    } else if (data.audio) {
                        // è·å–è¿™ä¸ªå—çš„éŸ³é¢‘æ•°æ®
                        try {
                            // è§£ç éŸ³é¢‘æ•°æ®
                            const pcmData = decodeBase64ToPCM(data.audio);
                            
                            // å¤„ç†éŸ³é¢‘å—
                            const sentenceId = data.sentence_id || currentSentenceId;
                            if (sentenceId) {
                                addAudioChunk(sentenceId, pcmData, data);
                            } else {
                                console.warn("æ”¶åˆ°éŸ³é¢‘å—ä½†æ²¡æœ‰å…³è”çš„å¥å­ID");
                            }
                        } catch (e) {
                            console.error('å¤„ç†éŸ³é¢‘å—å‡ºé”™:', e);
                        }
                    } else if (data.rawAudio) {
                        // ç›´æ¥å¤„ç†åŸå§‹éŸ³é¢‘æ•°æ®
                        const sentenceId = data.sentence_id || currentSentenceId;
                        if (sentenceId) {
                            addAudioChunk(sentenceId, data.rawAudio, data);
                        } else {
                            console.warn("æ”¶åˆ°éŸ³é¢‘å—ä½†æ²¡æœ‰å…³è”çš„å¥å­ID");
                        }
                    }
                    break;
                
                case 'tts_audio':
                    // å¤„ç†è€çš„TTSéŸ³é¢‘æ ¼å¼ï¼ˆä¸ºäº†å…¼å®¹ï¼‰
                    if (data.audio) {
                        try {
                            const pcmData = decodeBase64ToPCM(data.audio);
                            playLegacyAudio(pcmData, data.is_first);
                        } catch (e) {
                            console.error('å¤„ç†å®Œæ•´éŸ³é¢‘å‡ºé”™:', e);
                        }
                    }
                    break;
                
                case 'status':
                    if (data.status === 'listening') {
                        updateStatus('listening', 'æ­£åœ¨å¬å–...');
                    } else if (data.status === 'stopped') {
                        updateStatus('idle', 'å·²åœæ­¢');
                    }
                    break;
                
                case 'error':
                    console.error('Server error:', data.message);
                    updateStatus('error', `é”™è¯¯: ${data.message}`);
                    llmStatus.textContent = data.message;
                    break;
                
                case 'server_interrupt':
                    // æ–°å¢ï¼šå¤„ç†æœåŠ¡å™¨å‘é€çš„æ‰“æ–­ä¿¡ä»¤
                    console.log("æ”¶åˆ°æœåŠ¡å™¨æ‰“æ–­ä¿¡ä»¤:", data.message);
                    
                    // æ¸…ç©ºæ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                    stopAudioPlayback();
                    
                    // æ›´æ–°UIçŠ¶æ€
                    updateStatus('listening', 'å·²æ‰“æ–­ï¼Œæ­£åœ¨å¬å–...');
                    llmStatus.textContent = 'å“åº”å·²æ‰“æ–­';
                    isAIResponding = false;
                    
                    // æ˜¾ç¤ºé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
                    const notification = document.createElement('div');
                    notification.className = 'interrupt-notification';
                    notification.textContent = 'æ£€æµ‹åˆ°æ–°çš„è¯­éŸ³è¾“å…¥ï¼ŒAIå“åº”å·²æ‰“æ–­';
                    notification.style.position = 'fixed';
                    notification.style.top = '20px';
                    notification.style.left = '50%';
                    notification.style.transform = 'translateX(-50%)';
                    notification.style.padding = '10px 20px';
                    notification.style.backgroundColor = 'rgba(255, 87, 34, 0.9)';
                    notification.style.color = 'white';
                    notification.style.borderRadius = '4px';
                    notification.style.zIndex = '1000';
                    document.body.appendChild(notification);
                    
                    // 1.5ç§’åç§»é™¤é€šçŸ¥
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 1500);
                    break;
                
                default:
                    console.log('Unhandled message type:', data.type, data);
            }
        }
        
        // å¤„ç†äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
        async function handleBinaryAudioData(blob, header) {
            try {
                console.log(`æ”¶åˆ°äºŒè¿›åˆ¶éŸ³é¢‘å—: #${header.chunk_number}, å¤§å°: ${blob.size}å­—èŠ‚`);
                
                // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–
                if (!audioContext) {
                    initAudioContext();
                }
                
                // å°†Blobè½¬æ¢ä¸ºArrayBuffer
                const arrayBuffer = await blob.arrayBuffer();
                
                // ç›´æ¥å¤„ç†PCMæ•°æ®
                try {
                    const audioBuffer = await pcmToAudioBuffer(arrayBuffer);
                    
                    // æ·»åŠ åˆ°é€‚å½“çš„å¥å­
                    const sentenceId = header.sentence_id;
                    if (sentenceId) {
                        // åˆ›å»ºç®€åŒ–çš„å—ä¿¡æ¯å¯¹è±¡
                        const chunkInfo = {
                            chunk_number: header.chunk_number,
                            is_first: header.is_first_chunk,
                            sentence_id: sentenceId,
                            session_id: header.session_id
                        };
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå—ï¼Œè®°å½•å¹¶æ‰“å°æ—¥å¿—
                        if (header.is_first_chunk) {
                            console.log(`å¼€å§‹æ¥æ”¶æ–°çš„éŸ³é¢‘å¥å­: å— #${header.chunk_number}, å¥å­ID: ${sentenceId}`);
                        }
                        
                        // æ·»åŠ åˆ°å¥å­ä¸­
                        addAudioChunk(sentenceId, arrayBuffer, chunkInfo);
                    } else {
                        console.warn("æ”¶åˆ°äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®ä½†æ²¡æœ‰å…³è”çš„å¥å­ID");
                    }
                } catch (decodeError) {
                    console.error('éŸ³é¢‘è§£ç é”™è¯¯:', decodeError);
                    
                    // å°è¯•ç›´æ¥æ’­æ”¾åŸå§‹PCMæ•°æ®ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                    console.log('å°è¯•ç›´æ¥æ’­æ”¾åŸå§‹PCMæ•°æ®...');
                    playRawPCM(arrayBuffer, header.is_first_chunk);
                }
            } catch (e) {
                console.error('å¤„ç†äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®å‡ºé”™:', e);
            }
        }
        
        // ç›´æ¥æ’­æ”¾åŸå§‹PCMæ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function playRawPCM(pcmData, isFirst) {
            if (!audioContext) {
                initAudioContext();
            }
            
            try {
                // è½¬æ¢PCMæ•°æ®ä¸º16ä½æ•´æ•°æ•°ç»„
                const int16Array = new Int16Array(pcmData);
                
                // è½¬æ¢ä¸ºæµ®ç‚¹æ•°æ•°ç»„
                const floatArray = new Float32Array(int16Array.length);
                for (let i = 0; i < int16Array.length; i++) {
                    floatArray[i] = int16Array[i] / 32768.0;
                }
                
                // åˆ›å»ºéŸ³é¢‘ç¼“å†²åŒº
                const buffer = audioContext.createBuffer(1, floatArray.length, 16000);
                buffer.getChannelData(0).set(floatArray);
                
                // æ’­æ”¾
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                
                // å¦‚æœå·²ç»æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œåœæ­¢å®ƒ
                if (isPlayingAudio && currentAudioSource) {
                    try {
                        currentAudioSource.stop();
                    } catch (e) {
                        console.warn('åœæ­¢å½“å‰éŸ³é¢‘æºæ—¶å‡ºé”™:', e);
                    }
                }
                
                // è®°å½•å½“å‰éŸ³é¢‘æº
                currentAudioSource = source;
                
                // è®¾ç½®æ’­æ”¾ç»“æŸå¤„ç†
                source.onended = () => {
                    isPlayingAudio = false;
                    currentAudioSource = null;
                };
                
                // å¼€å§‹æ’­æ”¾
                source.start(0);
                isPlayingAudio = true;
                console.log('ç›´æ¥æ’­æ”¾PCMæ•°æ®, é•¿åº¦:', floatArray.length);
                
                return true;
            } catch (e) {
                console.error('ç›´æ¥æ’­æ”¾PCMæ•°æ®å‡ºé”™:', e);
                return false;
            }
        }
        
        // åˆå§‹åŒ–å¥å­
        function initSentence(sentenceId, text, isFirst) {
            console.log(`åˆå§‹åŒ–å¥å­: ${text}, ID: ${sentenceId}, æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ª: ${isFirst}`);
            
            // æ£€æŸ¥å¥å­æ˜¯å¦å·²å­˜åœ¨
            if (activeSentences.has(sentenceId)) {
                console.warn(`å¥å­ ${sentenceId} å·²ç»å­˜åœ¨ï¼Œå°†è¢«è¦†ç›–`);
            }
            
            // å­˜å‚¨å¥å­æ•°æ®
            activeSentences.set(sentenceId, {
                id: sentenceId,
                text: text,
                isFirst: isFirst,
                chunks: [],
                isComplete: false,
                startTime: Date.now()
            });
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå¥å­ï¼Œè®¾ç½®ä¸ºå½“å‰å¥å­ID
            if (isFirst) {
                currentSentenceId = sentenceId;
            }
            
            // å°†å¥å­æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—
            sentencePlayQueue.push(sentenceId);
            
            // å°è¯•å¤„ç†å¥å­é˜Ÿåˆ—
            processSentenceQueue();
        }
        
        // æ·»åŠ éŸ³é¢‘å—åˆ°å¥å­
        function addAudioChunk(sentenceId, audioData, chunkInfo) {
            // è·å–å¥å­æ•°æ®
            let sentence = activeSentences.get(sentenceId);
            
            // å¦‚æœå¥å­ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¥å­
            if (!sentence) {
                console.log(`ä¸ºæœªçŸ¥å¥å­ ${sentenceId} åˆ›å»ºæ–°å¥å­æ¡ç›®`);
                sentence = {
                    id: sentenceId,
                    text: chunkInfo.text || "",
                    isFirst: chunkInfo.is_first || false,
                    chunks: [],
                    isComplete: false,
                    startTime: Date.now()
                };
                activeSentences.set(sentenceId, sentence);
                
                // å°†å¥å­æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—
                sentencePlayQueue.push(sentenceId);
            }
            
            // å°†éŸ³é¢‘å—æ·»åŠ åˆ°å¥å­
            pcmToAudioBuffer(audioData).then(audioBuffer => {
                sentence.chunks.push({
                    buffer: audioBuffer,
                    chunkNumber: chunkInfo.chunk_number || sentence.chunks.length + 1
                });
                
                // å¦‚æœå¥å­å·²ç»æ ‡è®°ä¸ºå®Œæˆå¹¶ä¸”åœ¨å¤„ç†ä¸­ï¼Œåˆ™å¤„ç†è¯¥å¥å­
                if (sentence.isComplete && sentence.id === currentSentenceId && !isPlayingAudio) {
                    processSentence(sentence.id);
                }
            });
        }
        
        // å®Œæˆå¥å­
        function finalizeSentence(sentenceId) {
            // è·å–å¥å­
            let sentence = activeSentences.get(sentenceId);
            
            if (sentence) {
                console.log(`å®Œæˆå¥å­: ${sentence.text}, ID: ${sentenceId}, å…± ${sentence.chunks.length} ä¸ªå—`);
                
                // æ ‡è®°å¥å­å®Œæˆ
                sentence.isComplete = true;
            } else {
                console.warn(`å°è¯•å®Œæˆä¸å­˜åœ¨çš„å¥å­: ${sentenceId}`);
            }
            
            // å°è¯•å¤„ç†å¥å­é˜Ÿåˆ—
            processSentenceQueue();
        }
        
        // å¤„ç†å¥å­é˜Ÿåˆ—
        function processSentenceQueue() {
            // å¦‚æœæ­£åœ¨å¤„ç†æˆ–æ²¡æœ‰å¥å­ï¼Œåˆ™è¿”å›
            if (isProcessingSentence || sentencePlayQueue.length === 0) {
                return;
            }
            
            // å°è¯•å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå¥å­
            const nextSentenceId = sentencePlayQueue[0];
            processSentence(nextSentenceId);
        }
        
        // å¤„ç†å•ä¸ªå¥å­
        function processSentence(sentenceId) {
            // è·å–å¥å­
            const sentence = activeSentences.get(sentenceId);
            
            if (!sentence) {
                console.warn(`å°è¯•å¤„ç†ä¸å­˜åœ¨çš„å¥å­: ${sentenceId}`);
                
                // ç§»é™¤æ­¤å¥å­IDå¹¶å¤„ç†ä¸‹ä¸€ä¸ª
                sentencePlayQueue.shift();
                processSentenceQueue();
                return;
            }
            
            // æ ‡è®°æ­£åœ¨å¤„ç†
            isProcessingSentence = true;
            
            console.log(`å¤„ç†å¥å­: ${sentence.text}, ID: ${sentenceId}, çŠ¶æ€: ${sentence.isComplete ? 'å®Œæˆ' : 'æœªå®Œæˆ'}, å—æ•°: ${sentence.chunks.length}`);
            
            // å¦‚æœå¥å­æ²¡æœ‰å—æˆ–è€…è¿˜æ²¡å®Œæˆä¸”å·²å¤„ç†è¶…è¿‡100msï¼Œåˆ™å»¶è¿Ÿå¤„ç†
            if (sentence.chunks.length === 0 || (!sentence.isComplete && Date.now() - sentence.startTime < 100)) {
                console.log(`å¥å­ ${sentenceId} è¿˜æ²¡æœ‰éŸ³é¢‘å—æˆ–åˆšåˆšå¼€å§‹ï¼Œç¨åå¤„ç†`);
                isProcessingSentence = false;
                
                // 50msåå†æ¬¡å°è¯•
                setTimeout(() => {
                    processSentenceQueue();
                }, 50);
                return;
            }
            
            // å¯¹å—è¿›è¡Œæ’åº
            sentence.chunks.sort((a, b) => a.chunkNumber - b.chunkNumber);
            
            // åˆå¹¶éŸ³é¢‘å—
            mergeSentenceChunks(sentence).then(mergedBuffer => {
                // ç§»é™¤æ­¤å¥å­ID
                sentencePlayQueue.shift();
                
                // æ’­æ”¾åˆå¹¶åçš„éŸ³é¢‘
                playAudioBuffer(mergedBuffer).then(() => {
                    console.log(`å¥å­ ${sentenceId} æ’­æ”¾å®Œæˆ`);
                    
                    // å¦‚æœå·²ç»å®Œæˆå¹¶ä¸”æœ‰å—ï¼Œä»æ´»åŠ¨å¥å­ä¸­ç§»é™¤
                    if (sentence.isComplete && sentence.chunks.length > 0) {
                        activeSentences.delete(sentenceId);
                    }
                    
                    // æ ‡è®°å¤„ç†å®Œæˆ
                    isProcessingSentence = false;
                    
                    // å¤„ç†ä¸‹ä¸€ä¸ªå¥å­
                    processSentenceQueue();
                }).catch(error => {
                    console.error(`æ’­æ”¾å¥å­ ${sentenceId} æ—¶å‡ºé”™:`, error);
                    isProcessingSentence = false;
                    processSentenceQueue();
                });
            }).catch(error => {
                console.error(`åˆå¹¶å¥å­ ${sentenceId} çš„éŸ³é¢‘å—æ—¶å‡ºé”™:`, error);
                isProcessingSentence = false;
                
                // ç§»é™¤æ­¤å¥å­IDå¹¶å¤„ç†ä¸‹ä¸€ä¸ª
                sentencePlayQueue.shift();
                processSentenceQueue();
            });
        }
        
        // åˆå¹¶å¥å­çš„éŸ³é¢‘å—
        async function mergeSentenceChunks(sentence) {
            if (sentence.chunks.length === 0) {
                throw new Error(`å¥å­ ${sentence.id} æ²¡æœ‰éŸ³é¢‘å—`);
            }
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªå—ï¼Œç›´æ¥è¿”å›
            if (sentence.chunks.length === 1) {
                return sentence.chunks[0].buffer;
            }
            
            // è®¡ç®—æ€»é•¿åº¦
            let totalLength = 0;
            for (let chunk of sentence.chunks) {
                totalLength += chunk.buffer.length;
            }
            
            // åˆ›å»ºåˆå¹¶åçš„ç¼“å†²åŒº
            const mergedBuffer = audioContext.createBuffer(1, totalLength, 16000);
            const channelData = mergedBuffer.getChannelData(0);
            
            // å¤åˆ¶æ•°æ®
            let offset = 0;
            for (let chunk of sentence.chunks) {
                const itemData = chunk.buffer.getChannelData(0);
                channelData.set(itemData, offset);
                offset += chunk.buffer.length;
            }
            
            return mergedBuffer;
        }
        
        // æ¸…ç©ºæ‰€æœ‰å¥å­çŠ¶æ€
        function clearAllSentences() {
            activeSentences.clear();
            sentencePlayQueue = [];
            audioBufferQueue = [];
            currentSentenceId = null;
            isProcessingSentence = false;
        }
        
        // æ’­æ”¾éŸ³é¢‘ç¼“å†²åŒº
        async function playAudioBuffer(audioBuffer) {
            if (!audioContext) {
                console.error('Audio context not initialized');
                return Promise.reject('Audio context not initialized');
            }
            
            return new Promise((resolve, reject) => {
                try {
                    // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å¤„äºæ´»åŠ¨çŠ¶æ€
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    console.log(`å‡†å¤‡æ’­æ”¾éŸ³é¢‘ç¼“å†²åŒº, é•¿åº¦: ${audioBuffer.length}, é‡‡æ ·ç‡: ${audioBuffer.sampleRate}Hz`);
                    
                    // åˆ›å»ºéŸ³é¢‘æº
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    
                    // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ï¼Œç”¨äºæ§åˆ¶éŸ³é‡
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = 1.0; // ç¡®ä¿éŸ³é‡æ˜¯æœ€å¤§çš„
                    
                    // è¿æ¥ï¼šéŸ³é¢‘æº -> å¢ç›ŠèŠ‚ç‚¹ -> è¾“å‡ºè®¾å¤‡
                    source.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // ä¿å­˜å½“å‰æ’­æ”¾çš„éŸ³é¢‘æºä»¥ä¾¿å¯ä»¥åœæ­¢
                    currentAudioSource = source;
                    
                    // æ·»åŠ æ’­æ”¾ç»“æŸäº‹ä»¶å¤„ç†
                    source.onended = () => {
                        console.log('Audio playback ended');
                        currentAudioSource = null;
                        isPlayingAudio = false;
                        resolve();
                    };
                    
                    // å¼€å§‹æ’­æ”¾
                    source.start(0);
                    isPlayingAudio = true;
                    console.log('å¼€å§‹æ’­æ”¾éŸ³é¢‘, ç¼“å†²åŒºé•¿åº¦:', audioBuffer.length);
                } catch (e) {
                    console.error('æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™:', e);
                    isPlayingAudio = false;
                    reject(e);
                }
            });
        }
        
        // åœæ­¢å½“å‰éŸ³é¢‘æ’­æ”¾
        function stopAudioPlayback() {
            if (currentAudioSource) {
                try {
                    currentAudioSource.stop();
                    currentAudioSource = null;
                } catch (e) {
                    console.error('Error stopping audio:', e);
                }
            }
            
            // æ¸…ç©ºé˜Ÿåˆ—
            audioQueue = [];
            audioBufferQueue = [];
            isPlayingAudio = false;
            
            // æ¸…ç©ºæ‰€æœ‰å¥å­çŠ¶æ€
            clearAllSentences();
            
            // æ–°å¢ï¼šå¦‚æœAIæ­£åœ¨å“åº”ï¼Œå‘é€ä¸­æ–­ä¿¡å·
            if (isAIResponding && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "interrupt" }));
                console.log("Interruption signal sent to server");
                isAIResponding = false;
            }
        }
        
        // Update status indicator
        function updateStatus(state, message) {
            statusDot.className = `status-dot ${state}`;
            statusText.textContent = message;
        }
        
        // Add message to history
        function addToHistory(text, type) {
            const item = document.createElement('div');
            item.className = type === 'user' ? 'history-item-user' : 'history-item-llm';
            
            if (type === 'user') {
                item.textContent = `ğŸ‘¤ ${text}`;
            } else {
                item.textContent = `ğŸ¤– ${text}`;
            }
            
            history.prepend(item);
        }
        
        // é‡é‡‡æ ·å‡½æ•° - å°†ä»»æ„é‡‡æ ·ç‡è½¬æ¢ä¸º16kHz
        function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
            if (inputSampleRate === outputSampleRate) {
                return buffer;
            }
            
            const sampleRateRatio = inputSampleRate / outputSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            
            let offsetResult = 0;
            let offsetBuffer = 0;
            
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0, count = 0;
                
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            
            return result;
        }
        
        // ä»Float32è½¬æ¢ä¸ºInt16 (PCM)
        function convertFloat32ToInt16(buffer) {
            const l = buffer.length;
            const buf = new Int16Array(l);
            
            for (let i = 0; i < l; i++) {
                // è½¬æ¢ä¸º16ä½æœ‰ç¬¦å·æ•´æ•°
                // å°†-1åˆ°1çš„èŒƒå›´è½¬æ¢ä¸º-32768åˆ°32767
                const s = Math.max(-1, Math.min(1, buffer[i]));
                buf[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            
            return buf;
        }
        
        // è®°å½•éŸ³é¢‘çŠ¶æ€ä¾›è¯Šæ–­
        function logAudioState(audioBuffer) {
            // æ¯10ç§’è®°å½•ä¸€æ¬¡éŸ³é¢‘çŠ¶æ€
            if (!logAudioState.lastLog || Date.now() - logAudioState.lastLog > 10000) {
                // åˆ†æéŸ³é¢‘å¹…åº¦
                let sum = 0, max = 0, min = 0;
                for (let i = 0; i < audioBuffer.length; i++) {
                    sum += Math.abs(audioBuffer[i]);
                    max = Math.max(max, audioBuffer[i]);
                    min = Math.min(min, audioBuffer[i]);
                }
                const avg = sum / audioBuffer.length;
                
                console.log(`éŸ³é¢‘çŠ¶æ€: å¹³å‡å¹…åº¦=${avg.toFixed(4)}, èŒƒå›´=${min.toFixed(4)}åˆ°${max.toFixed(4)}, é‡‡æ ·ç‡=${originalSampleRate}Hz${resampleRequired ? '(éœ€è¦é‡é‡‡æ ·)' : ''}`);
                
                // æ£€æµ‹éº¦å…‹é£å¯èƒ½çš„é™éŸ³çŠ¶æ€
                if (avg < 0.0001 && max - min < 0.001) {
                    console.warn("è­¦å‘Š: æ£€æµ‹åˆ°å¯èƒ½çš„é™éŸ³è¾“å…¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£");
                }
                
                logAudioState.lastLog = Date.now();
            }
        }
        
        // æ’­æ”¾æ—§ç‰ˆå®Œæ•´éŸ³é¢‘ï¼ˆä¸ºå…¼å®¹ä¿ç•™ï¼‰
        function playLegacyAudio(pcmData, isFirst) {
            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–
            if (!audioContext && !initAudioContext()) {
                console.error("æ— æ³•åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡");
                return false;
            }
            
            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å¤„äºæ´»åŠ¨çŠ¶æ€
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // è½¬æ¢ä¸ºAudioBufferå¹¶æ’­æ”¾
            pcmToAudioBuffer(pcmData).then(audioBuffer => {
                playOrQueueBuffer(audioBuffer, isFirst);
            });
        }
        
        // æ’­æ”¾æˆ–æ’é˜ŸéŸ³é¢‘ç¼“å†²åŒº
        function playOrQueueBuffer(audioBuffer, isFirst, text) {
            if (isFirst) {
                console.log(`å¼€å§‹æ’­æ”¾æ–°çš„éŸ³é¢‘: ${text || "æ— æ–‡æœ¬"}`);
            }
            
            if (isFirst || (!isPlayingAudio && audioQueue.length === 0)) {
                // ç›´æ¥æ’­æ”¾
                playAudioBuffer(audioBuffer);
            } else {
                // æ·»åŠ åˆ°é˜Ÿåˆ—
                audioQueue.push(audioBuffer);
            }
        }
        
        // Start audio recording and streaming
        async function startRecording() {
            try {
                // Check browser compatibility
                if (!checkBrowserCompatibility()) {
                    return;
                }
                
                // Request microphone access with fallbacks for different browsers
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                
                // Request microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                // Create audio context
                audioContext = new AudioContext();
                originalSampleRate = audioContext.sampleRate;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡é‡‡æ ·
                resampleRequired = originalSampleRate !== SAMPLE_RATE;
                console.log(`åŸå§‹é‡‡æ ·ç‡: ${originalSampleRate}Hz, ç›®æ ‡é‡‡æ ·ç‡: ${SAMPLE_RATE}Hz, éœ€è¦é‡é‡‡æ ·: ${resampleRequired}`);
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                
                // Create script processor node for streaming audio
                processor = audioContext.createScriptProcessor(BUFFER_SIZE, CHANNELS, CHANNELS);
                
                processor.onaudioprocess = function(e) {
                    if (!isRecording || !socket || socket.readyState !== WebSocket.OPEN) return;
                    
                    // è·å–éŸ³é¢‘æ•°æ®
                    const inputData = e.inputBuffer.getChannelData(0);
                    
                    // è®°å½•åŸå§‹éŸ³é¢‘çŠ¶æ€
                    logAudioState(inputData);
                    
                    // æ–°å¢ï¼šæ£€æµ‹ç”¨æˆ·æ˜¯å¦åœ¨AIå“åº”æ—¶å¼€å§‹è¯´è¯
                    if (isAIResponding && isPlayingAudio) {
                        // æ£€æµ‹æ˜¯å¦æœ‰æ˜¾è‘—çš„å£°éŸ³è¾“å…¥
                        const audioLevel = detectAudioLevel(inputData);
                        if (audioLevel > 0.05) { // å¯ä»¥è°ƒæ•´è¿™ä¸ªé˜ˆå€¼
                            console.log("User started speaking while AI is responding. Interrupting...");
                            stopAudioPlayback(); // è¿™å°†è§¦å‘ä¸­æ–­ä¿¡å·
                        }
                    }
                    
                    // æ ¹æ®éœ€è¦é‡é‡‡æ ·
                    let audioToProcess = inputData;
                    if (resampleRequired) {
                        audioToProcess = downsampleBuffer(inputData, originalSampleRate, SAMPLE_RATE);
                    }
                    
                    // è½¬æ¢ä¸º16ä½PCM
                    const pcmData = convertFloat32ToInt16(audioToProcess);
                    
                    // å‘é€åˆ°æœåŠ¡å™¨
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(pcmData.buffer);
                    }
                };
                
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                updateStatus('listening', 'æ­£åœ¨å¬å–...');
                
                // Update UI
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // Send start command
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'start' }));
                }
                
            } catch (error) {
                console.error('Error starting recording:', error);
                
                let errorMessage = 'éº¦å…‹é£è®¿é—®é”™è¯¯';
                
                if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'æ‰¾ä¸åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·ç¡®è®¤æ‚¨çš„è®¾å¤‡å·²æ­£ç¡®è¿æ¥ã€‚';
                } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'éº¦å…‹é£è®¿é—®è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨ä¸­å…è®¸éº¦å…‹é£è®¿é—®æƒé™ã€‚';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£ã€‚å¯èƒ½è¢«å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨ã€‚';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage = 'éº¦å…‹é£ä¸ç¬¦åˆè¦æ±‚çš„å‚æ•°ã€‚';
                } else if (error.name === 'TypeError') {
                    errorMessage = 'æµè§ˆå™¨APIé”™è¯¯ã€‚è¯·å°è¯•ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Edgeæˆ–Firefoxæµè§ˆå™¨ã€‚';
                }
                
                updateStatus('error', errorMessage);
                browserWarning.style.display = 'block';
                browserWarning.innerHTML = `<strong>é”™è¯¯:</strong> ${errorMessage}`;
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            
            // Stop media stream tracks
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // Disconnect audio nodes
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            
            // Close audio context
            if (audioContext) {
                audioContext.close().catch(console.error);
                audioContext = null;
            }
            
            // Send stop command
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'stop' }));
            }
            
            // Update UI
            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('idle', 'å·²åœæ­¢');
        }
        
        // Reset everything
        function resetSession() {
            // Stop recording if active
            if (isRecording) {
                stopRecording();
            }
            
            // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
            stopAudioPlayback();
            
            // Clear displays
            partialTranscript.textContent = '';
            finalTranscript.textContent = '';
            llmResponse.textContent = '';
            llmStatus.textContent = '';
            
            // Send reset command
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "reset" }));
            }
            
            updateStatus('idle', 'å·²é‡ç½®');
        }
        
        // Event listeners
        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
        resetBtn.addEventListener('click', resetSession);
        
        // Initialize connection when page loads
        window.addEventListener('load', function() {
            // Check browser compatibility first
            checkBrowserCompatibility();
            // Initialize WebSocket
            initializeWebSocket();
            // æ·»åŠ éŸ³é¢‘å·¥å…·æ 
            addAudioToolbar();
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                stopRecording();
            }
            if (socket) {
                socket.close();
            }
        });
        
        // æ–°å¢ï¼šæ£€æµ‹éŸ³é¢‘ç”µå¹³çš„å‡½æ•°
        function detectAudioLevel(audioBuffer) {
            let sum = 0;
            for (let i = 0; i < audioBuffer.length; i++) {
                sum += Math.abs(audioBuffer[i]);
            }
            return sum / audioBuffer.length;
        }
    </script>
</body>
</html> 